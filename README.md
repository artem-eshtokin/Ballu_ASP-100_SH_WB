## MQTT для бризера Ballu ONEAIR ASP-100 и интеграция в SprutHub на WirenBoard

Оринигальный [репозиторий](https://github.com/v-vadim/Ballu_ASP-100/) созданный для Home Assistant.

Со своей стороны, я делал запрос в техподдержку, по интеграции бризера в локальную систему "умный дом". На что получил ответ:
> На данный момент данная опция в стадии разработки и доступна только для конвекторов в тестовом режиме.

Поэтому дальнейшие действия считаю временным решением до реализации технической возможности со стороны производителя.

**0. Общая схема решения**

Бризер управляется через приложение Hommyn. Обмен данными происходит через популярный MQTT-протокол:

Бризер <=> Роутер <=> mqtt.cloud.rusklimat.ru <=> Hommyn

Реализованное решение:

Бризер <=> Роутер <=> MQTT-брокер <=> MQTT-WirenBoard <=> SprutHub

При этом внутри сети (или через домашний vpn) сохраняется работоспособность приложения Hommyn:

Бризер <=> Роутер <=> MQTT-брокер <=> Роутер <=> Hommyn

**1. Важная информация про mosquitto**

Я долго не мог решить проблему с MQTT-брокером, пока не получил информацию из оригинального репозитория:

> Для работы с бризером необходимо установить и настроить MQTT брокер EMQX или Mosquitto 1.5.11 (Не работает с mosquitto выше 1.5.11)
> В MQTT брокере необходимо включить и настроить поддержку SSL на порту 8883 (Сертификат можно любой, бризер не проверяет сертификат сервера mqtt) Включить авторизацию по логину-паролю и добавить пользователя rusclimate с паролем указанным в конфиге (Логин и пароль зашиты в прошивку бризера и являются одинаковыми для всех устройств)

В моём случае, аппаратная платформа WirenBoard 7 (Debian 11) установлена mosquitto v 2.0.20. Я не стал ставить параллельно mosquitto 1.5.11, чтобы в будущем не усложнять обновление платформы, и при наличии домашнего сервачка с докером.

**2. Запуск Docker-контейнера mosquitto**

Файл *docker/docker-compose.yml* раздел # mosquitto for ballu

- Сертификаты можно просто скопировать. Важно их наличие, а не содержимое.
- Конфиг mosquitto.conf раздел # MQTT-брокер можно просто скопировать.

Запустив данный контейнер, получите работающий с бризером Ballu MQTT-брокер: <IP-адрес докер>:8883

**3. Внесение локальной DNS-записи на роутере**

На роутере необходимо настроить DNS запись mqtt.cloud.rusklimat.ru => <IP-адрес MQTT-брокера> из п. 2.

> В роутере Keenetic, добавление записи делается через CLI:  
(config)> ip host mqtt.cloud.rusklimat.ru <IP-адрес MQTT-брокера>  
(config)> system configuration save

---

**ВНИМАНИЕ!**  
При использовании сервера **dnsmasq**, можно добавить двумя способами:

1. В файл /opt/etc/dnsmasq.d/hosts.dnsmasq:

> nano /opt/etc/dnsmasq.d/hosts.dnsmasq  

> address=/mqtt.cloud.rusklimat.ru/<IP-адрес MQTT-брокера>

2. В файл /opt/etc/hosts

> nano /opt/etc/hosts

> <IP-адрес MQTT-брокера> mqtt.cloud.rusklimat.ru

Необходимо перезапустить сервис dnsmasq командой:

> /opt/etc/init.d/S56dnsmasq restart

---

После внесения DNS-записи необходимо на 10 секунд отключить питание бризера **для сброса его кэша DNS**.  
Можно проверить работу приложением Hommyn - внутри сети работает, извне бризер будет недоступен.

**4. Подключение к MQTT-брокеру**

- Необходимо подключиться к вашему MQTT-брокеру с помощью [MQTT Explorer](https://mqtt-explorer.com/)  
Protocol: mqtt://  
Host: <IP-адрес MQTT-брокера>  
Port: 8883  
Encrypion (tls): ON  
- Найти топик rusclimate/<device_type>/<device_id>/
- Пояснение по топикам:  
>/state - получение  
/control - установка

>/state/mode - текущий режим работы бризера:  
>>0 - выключен  
1 - ручная регулировка скорости и температуры  
2 - авто, при наличии подключенного датчика СО2 (рекомендуется использовать внешний)  
3 - ночной режим  
4 - турбо  
5 - открытая заслонка, пассивная вентиляция  
/control/mode - установка режима работы бризера

>/state/temperature - целевая температура  
/control/temperature - установка целевой температуры (5С - 25С)

>/state/sensor/temperature - показания встроенного датчика температуры

>/state/speed - скорость работы вентилятора  
/control/speed - установка скорости работы вентилятора

Остальные топики считаю невостребованными для сценариев, поэтому не вижу смысла их переносить.

**5. Проброс топиков в mosquitto WirenBoard**

Конфиг mosquitto.conf раздел # Настройка бриджа

Переношу на WirenBoard только некоторые топики и сразу в структуру топиков по формату WirenBoard.

На примере топика mode:

> topic mode both 1 rusclimate/<device_type>/<device_id>/state/ /devices/ballu_asp-100_1/controls/  
topic mode both 1 rusclimate/<device_type>/<device_id>/control/ /devices/ballu_asp-100_1/controls/mode/set_  

где:  
*mode* - название локального топика  
*both* - сообщения пересылаются в обе стороны (из локального брокера в удалённый и наоборот)  
*1* - QoS  передачи - "at least once" (гарантированная доставка, но возможны дубли)  
*rusclimate/<device_type>/<device_id>/state/* - путь локального топика (внимательно по слэшам)  
*/devices/ballu_asp-100_1/controls/* - путь на удалённом брокере.

> в данном случае *_1* это порядковый номер бризера и если их несколько, то должны отличаться номера 

*/devices/ballu_asp-100_1/controls/mode/set_* - тут на удаленном брокере топик будет set_mode внутри топика mode

**6. Топик current_heater**

Этот топик отсутствует в стандартной схеме бризера Ballu. Он искусствено вычисляется python-скриптом в контейнере mqtt-heater-control (файл *docker/docker-compose.yml* раздел # mqtt heater control script). 

> Управление нагревом в бризере автоматическое и нет возможности управлять извне - только установить целевую температуру. 
Минимальная устанавливаемая температура +5С и если поступающий воздух ниже этой температуры, то нагрев будет включаться в автоматическом режиме. 
Для своих сценариев в "умном доме" мне нужно знать, когда "работает" нагрев, например, понижать целевую температуру в пиковые (дорогие) тарифные часы. 

Сам скрипт простой *docker/config/mqtt_scripts/mqtt_heater_control.py*  
Отображение состояния нагревателя в зависимости от температуры воздуха и целевой температуры.

**7. Топик /state/mode/meta/type**

Так как этот способ интеграции не нативный, а костыльный, то нужен скрипт который генерирует meta.  
Он искусствено создаётся python-скриптом в контейнере mqtt-mode-meta-checker (файл *docker/docker-compose.yml* раздел # mqtt mode meta checker).

**8. Шаблон для WirenBoard**

На данный момент не создавался, т.к. большая часть сценариев выполняется на SprutHub и вывод в интерфейс WirenBoard не требуется.

**9. Шаблон для SprutHub**

Файл *ballu_asp-100.json*  
Шаблон для интеграции бризера Ballu ASP-100 в SprutHub создан на базе двух сервисов:  

1. Сервис *Вентилятор (Fan)*  
- состояние (Active) берёт значения из топика mode (см. ниже)
- текущий режим вентилятора (CurrentFanState) **тоже** берёт значения из топика mode (см. ниже)
- скорость вентилятора (RotationSpeed) - топик speed

2. Сервис *Термостат (Thermostat)*
- текущий режим термостата (CurrentHeatingCoolingState) берёт значения из топика current_heater (тот самый из п. 6)
- целевой режим термостата (TargetHeatingCoolingState) всегда выдаёт одно значение Heat (нельзя убрать, обязательное поле)
- температура (CurrentTemperature) - топик /sensor/temperature (показания датчика)
- целевая температура (TargetTemperature) - топик temperature
- ед. изм. (TemperatureDisplayUnits) - всегда C.

<<<<<<< HEAD
Пояснение по топику mode.
От производителя бризер имеет 6 режимов, но в интеграции достаточно двух:

0 - выключен  
1 - ручная регулировка скорости и температуры

Другие режимы заменяют сценарии SprutHub:

2 - авто - сценарий зависимость скорость от показаний внешнего датчика CO2  
3 - ночной режим, сценарий вентиляции ночью (не выше 3 скорости и в зависимости от CO2)  
4 - турбо, бризер в этом режиме включает 8 скорость, но только на 15 минут, поэтому в сценарии SprutHub при плохих показателях датчиков работает скорость 7  
5 - открытая заслонка, реализуется установкой mode=1 и speed=0  
=======
Пояснение по топику mode.  
От производителя бризер имеет 6 режимов, но в интеграции достаточно двух:  
- 0 - выключен  
- 1 - ручная регулировка скорости и температуры  
Другие режимы заменяют сценарии SprutHub:
- 2 - авто - сценарий зависимость скорость от показаний внешнего датчика CO2
- 3 - ночной режим, сценарий вентиляции ночью (не выше 3 скорости и в зависимости от CO2)
- 4 - турбо, бризер в этом режиме включает 8 скорость, но только на 15 минут, поэтому в сценарии SprutHub при плохих показателях датчиков работает скорость 7
- 5 - открытая заслонка, реализуется установкой mode=1 и speed=0
>>>>>>> 2c8072faf8dc6d75a07f0d0676607f5bd644eff2

Шаблон загружается в */mnt/data/makesimple/.SprutHub/data/Templates/MQTT/Custom*.  
В веб-интерфейсе SprutHub в Настройки, Расширенные, Перезагрузить шаблоны.
